---
interface Props {
  title: string;
  /** Section id for aria-labelledby / anchor */
  id?: string;
  /** Start expanded (default: false) */
  open?: boolean;
  /** Use step-card styling for the container */
  stepCard?: boolean;
  /** When set with moduleId, section is bound to this task index for "Mark section complete" */
  taskIndex?: number;
  /** When set with taskIndex, section can mark the corresponding sidebar task complete */
  moduleId?: string;
}

const { title, id, open = false, stepCard = true, taskIndex, moduleId } = Astro.props;
const summaryId = id ? `${id}-summary` : undefined;
const hasTaskBinding = taskIndex !== undefined && taskIndex !== null && typeof moduleId === "string" && moduleId.length > 0;
const storageKey = hasTaskBinding ? `cursor-workshop-module-${moduleId}-tasks` : "";
---

<details
  id={id}
  class:list={["collapsible-section", stepCard && "collapsible-section--step-card"]}
  open={open}
  aria-labelledby={summaryId}
  data-task-index={hasTaskBinding ? taskIndex : undefined}
  data-module-id={hasTaskBinding ? moduleId : undefined}
>
  <summary id={summaryId} class="collapsible-section__summary">
    <span class="collapsible-section__title">{title}</span>
    <div class="collapsible-section__icons">
      <i data-lucide="chevron-down" class="chevron-icon chevron-icon--down w-5 h-5" aria-hidden="true"></i>
      <i data-lucide="chevron-up" class="chevron-icon chevron-icon--up w-5 h-5" aria-hidden="true"></i>
    </div>
  </summary>
  <div class="collapsible-section__content">
    <div class="collapsible-section__content-inner">
      <slot />
    </div>
  </div>
</details>

{hasTaskBinding && (
  <script define:vars={{ storageKey, taskIndex, moduleId }}>
    const details = document.querySelector(`.collapsible-section[data-module-id="${moduleId}"][data-task-index="${taskIndex}"]`);
    if (details) {
      const state = (() => { try { const raw = localStorage.getItem(storageKey); return raw ? JSON.parse(raw) : {}; } catch { return {}; } })();
      if (state[String(taskIndex)]) details.classList.add("section-complete");
    }
  </script>
)}