---
/**
 * Boot sequence overlay: 80s CRT / system-init vibe.
 * Shown on first visit (index) or when launching an app from desktop.
 * Content is driven by script: typewriter then "Proceed" button.
 */
---

<div id="boot-overlay" class="boot-overlay" role="status" aria-live="polite" aria-label="System initializing">
  <div class="boot-overlay__scanlines" aria-hidden="true"></div>
  <div class="boot-overlay__noise" aria-hidden="true"></div>
  <div class="boot-overlay__inner">
    <pre id="boot-overlay-text" class="boot-overlay__text" aria-live="polite"></pre>
    <div id="boot-overlay-actions" class="boot-overlay__actions" hidden>
      <button type="button" id="boot-overlay-proceed" class="boot-overlay__proceed workshop-btn workshop-btn--primary">
        Proceed to Desktop
      </button>
    </div>
  </div>
</div>

<script>
  import { SYSTEM_BOOT_LINES, MODULE_BOOT_LINES } from "../lib/boot-messages";

  const BOOT_SEEN_KEY = "cursor-workshop-has-seen-boot";
  const TYPED_MS_PER_CHAR = 40;

  const overlayEl = document.getElementById("boot-overlay");
  const textEl = document.getElementById("boot-overlay-text");
  const actionsEl = document.getElementById("boot-overlay-actions");
  const proceedBtn = document.getElementById("boot-overlay-proceed");

  if (!overlayEl || !textEl || !actionsEl || !proceedBtn) throw new Error("Boot overlay elements not found");

  const prefersReducedMotion = () => window.matchMedia("(prefers-reduced-motion: reduce)").matches;

  function typewriter(lines: string[], onDone: () => void) {
    const instant = prefersReducedMotion();
    const fullText = lines.join("\n");

    if (instant) {
      textEl.textContent = fullText;
      onDone();
      return;
    }

    let lineIdx = 0;
    let charIdx = 0;
    const displayed: string[] = [];

    function tick() {
      if (lineIdx >= lines.length) {
        onDone();
        return;
      }
      const line = lines[lineIdx];
      if (charIdx <= line.length) {
        displayed[lineIdx] = line.slice(0, charIdx);
        textEl.textContent = displayed.join("\n");
        charIdx++;
        setTimeout(tick, TYPED_MS_PER_CHAR);
      } else {
        lineIdx++;
        charIdx = 0;
        displayed[lineIdx - 1] = line;
        textEl.textContent = displayed.join("\n");
        if (lineIdx < lines.length) {
          setTimeout(tick, TYPED_MS_PER_CHAR);
        } else {
          onDone();
        }
      }
    }
    tick();
  }

  function showProceedButton(label: string, onClick: () => void) {
    proceedBtn.textContent = label;
    proceedBtn.onclick = () => onClick();
    actionsEl.hidden = false;
    proceedBtn.focus();
  }

  function runFirstBoot() {
    textEl.textContent = "";
    actionsEl.hidden = true;
    typewriter(SYSTEM_BOOT_LINES, () => {
      showProceedButton("Proceed to Desktop", () => {
        try {
          localStorage.setItem(BOOT_SEEN_KEY, "1");
        } catch {}
        overlayEl.classList.add("boot-overlay--exiting");
        document.documentElement.classList.remove("boot-first-visit");
        overlayEl.addEventListener(
          "transitionend",
          () => {
            overlayEl.classList.remove("boot-overlay--visible", "boot-overlay--exiting");
          },
          { once: true }
        );
      });
    });
  }

  function runAppBoot(moduleId: string, route: string, title: string) {
    overlayEl.classList.remove("boot-overlay--exiting");
    overlayEl.classList.add("boot-overlay--visible");
    textEl.textContent = "";
    actionsEl.hidden = true;
    const lines = MODULE_BOOT_LINES[moduleId] ?? ["> Loading...", "> Ready."];

    typewriter(lines, () => {
      showProceedButton(`Open ${title}`, () => {
        overlayEl.classList.add("boot-overlay--exiting");
        overlayEl.addEventListener(
          "transitionend",
          () => {
            window.location.href = route;
          },
          { once: true }
        );
      });
    });
  }

  if (document.documentElement.classList.contains("boot-first-visit")) {
    runFirstBoot();
  }

  window.addEventListener("workshop-show-app-boot", ((e: CustomEvent<{ moduleId: string; route: string; title: string }>) => {
    const { moduleId, route, title } = e.detail ?? {};
    if (moduleId && route) runAppBoot(moduleId, route, title ?? "Module");
  }) as EventListener);
</script>
