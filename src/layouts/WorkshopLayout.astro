---
import "../styles/global.css";
import SystemShell from "../components/SystemShell.astro";

interface Props {
  title: string;
  description?: string;
  bootOverlay?: boolean;
  /** Toggle subtle scanlines/noise overlay (default true) */
  ambient?: boolean;
}

const { title, description = "Onboard to Cursor and GitHub with this interactive workshop.", bootOverlay = false, ambient = true } = Astro.props;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,400;0,500;0,700;1,400;1,700&display=swap" rel="stylesheet" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css" />
    <title>{title} | Cursor Workshop</title>
    {bootOverlay && (
      <script is:inline>
        (function(){try{if(!localStorage.getItem("cursor-workshop-has-seen-boot"))document.documentElement.classList.add("boot-first-visit");}catch(e){}}());
      </script>
    )}
    <script is:inline>
      (function(){try{var v=localStorage.getItem("cursor-workshop-theme-intensity");var s=v==="low"||v==="high"?v:"medium";document.documentElement.setAttribute("data-theme-intensity",s);}catch(e){}}());
    </script>
  </head>
  <body>
    <SystemShell ambient={ambient}>
    <header class="workshop-app-bar" role="banner">
      <a href="/cursor-workshop/" class="workshop-app-bar__home" aria-label="Back to desktop">
        <img src="/cursor-workshop/icons/amiga/home.svg" alt="" width="32" height="32" />
      </a>
    </header>

    <div class="workshop-app">
      <main class="workshop-main">
        <slot />
      </main>
    </div>

    </SystemShell>

    <script>
      (function () {
        const VISITED_KEY = "cursor-workshop-visited-steps";

        function getVisited(): string[] {
          try {
            const raw = localStorage.getItem(VISITED_KEY);
            return raw ? JSON.parse(raw) : [];
          } catch {
            return [];
          }
        }

        function setVisited(paths: string[]) {
          try {
            localStorage.setItem(VISITED_KEY, JSON.stringify(paths));
          } catch {}
        }

        const pathname = window.location.pathname.replace(/\/$/, "") || "/cursor-workshop";
        const visited = getVisited();
        if (!visited.includes(pathname)) {
          visited.push(pathname);
          setVisited(visited);
        }
      })();
    </script>
    <script>
      (function () {
        const HOME = "/cursor-workshop/";

        function isTextInput(el: EventTarget | null): boolean {
          if (!el || !(el instanceof HTMLElement)) return false;
          const tag = el.tagName.toLowerCase();
          if (tag === "input" || tag === "textarea") return true;
          return el.isContentEditable === true;
        }

        document.addEventListener("keydown", (e) => {
          if (e.key !== "r" && e.key !== "R") return;
          if (e.ctrlKey || e.metaKey || e.altKey) return;
          if (isTextInput(e.target as EventTarget | null)) return;
          e.preventDefault();
          window.location.href = HOME;
        });
      })();
    </script>
    <script>
      (function () {
        function isInteractiveClickTarget(el: EventTarget | null): boolean {
          if (!el || !(el instanceof Element)) return false;
          const node = el as Element;
          const tag = node.tagName.toLowerCase();
          const role = node.getAttribute("role");
          if (tag === "a" || tag === "button") return true;
          if (tag === "input" && ["submit", "button", "checkbox", "radio"].includes((node as HTMLInputElement).type)) return true;
          if (role === "button" || role === "link" || role === "menuitem" || role === "tab") return true;
          const clickable = node.closest("a, button, [role=button], [role=link]");
          return !!clickable;
        }

        const CLICK_SOUND_URL = "/cursor-workshop/sounds/mouse-click.mp3";
        let clickAudio: HTMLAudioElement | null = null;

        function playClickSound() {
          try {
            if (typeof window === "undefined") return;
            if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;
            if (!clickAudio) clickAudio = new Audio(CLICK_SOUND_URL);
            clickAudio.currentTime = 0;
            clickAudio.play();
          } catch (_) {}
        }

        document.addEventListener("click", (e) => {
          if (isInteractiveClickTarget(e.target)) playClickSound();
        }, true);
      })();
    </script>
  </body>
</html>
